# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Kubernetes operator built with Kubebuilder v4.7.1 that manages HelloWorld custom resources. The operator is designed to deploy busybox pods in response to HelloWorld resource creation/updates.

## Essential Commands

### Development
```bash
# Run controller locally against current kubeconfig cluster
make run

# Build the manager binary
make build

# Generate CRD manifests, RBAC, etc. after API changes
make manifests

# Generate Go code after API changes
make generate
```

### Testing
```bash
# Run all unit tests with coverage
make test

# Run end-to-end tests (spins up Kind cluster)
make test-e2e

# Run specific test file
go test ./internal/controller/... -v
```

### Code Quality
```bash
# Run all linters
make lint

# Fix linting issues automatically
make lint-fix

# Format code
make fmt

# Run go vet
make vet
```

### Deployment
```bash
# Install CRDs into cluster
make install-crd

# Deploy controller to cluster
make deploy-controller IMG=<your-registry>/op-hello-world:tag

# Build and push Docker image
make docker-build docker-push IMG=<your-registry>/op-hello-world:tag

# Install a HelloWorld resource
make install-resource

# Install a custom HelloWorld resource
make install-resource RESOURCE_PATH=path/to/custom.yaml

# Uninstall the resource
make uninstall-resource
```

## Architecture

### API Structure
- **API Group**: `apps.example.com/v1`
- **Kind**: `HelloWorld`
- **API Definition**: `api/v1/helloworld_types.go` - Defines the CRD structure
- **Generated Code**: Run `make generate` after modifying API types

### Controller Implementation
- **Main Controller**: `internal/controller/helloworld_controller.go` - Contains the reconciliation logic
- **Reconcile Pattern**: The controller watches HelloWorld resources and reconciles desired state
- **RBAC**: Permissions are defined via kubebuilder markers in the controller file

### Testing Strategy
- **Unit Tests**: Located alongside code files (*_test.go), use Ginkgo/Gomega
- **Controller Tests**: Use envtest for simulated Kubernetes API
- **E2E Tests**: `test/e2e/` directory, run against real Kind cluster

### Key Design Patterns
1. **Reconciliation Loop**: All logic should be idempotent and handle partial failures
2. **Status Updates**: Update HelloWorld status to reflect current state
3. **Owner References**: Set owner references on created resources for garbage collection
4. **Error Handling**: Return errors with appropriate requeue logic

### Common Development Tasks
When implementing controller logic:
1. Define desired state based on HelloWorld spec
2. Check current state of managed resources
3. Create/Update/Delete resources to match desired state
4. Update HelloWorld status
5. Return appropriate Result and error for requeue behavior

## Code Style Guidelines

### Comments
- **DO** use comments to state where custom code is added because this project is generated by Kubebuilder.
- **DO NOT** add extraneous inline comments that state the obvious
- **DO NOT** add comments that simply restate what the code does
- **DO NOT** add comments for standard Go patterns (e.g., "// Semaphore for limiting concurrent operations", "// WaitGroup to track active workers")

Examples of comments to avoid:
```go
// BAD - States the obvious
// Process resources in batches
for i := 0; i < len(resources); i += MaxBatchSize {

// BAD - Restates what the code does
// Close send side
stream.CloseSend()

// BAD - Standard Go pattern
var wg sync.WaitGroup  // WaitGroup to track active workers
```

Examples of custom code delimiters:
```go
///////////////////////////////
// Custom code start
// This section handles the reconciliation logic for HelloWorld resources

stream, err := r.client.Stream(ctx, &corev1.PodList{
    stream.ObjectMeta = metav1.ObjectMeta{
        Name:      "hello-world-stream",
        Namespace: "default",
    },
})

// Custom code end
///////////////////////////////
```

Good comments should:
- Explain **why** something is done, not **what** is done
- Have beginning and ending delimiters for custom code
- Document complex business logic or algorithms
- Provide context that isn't obvious from the code
- Include TODO/FIXME notes for future work
- Document exported functions/types/methods
